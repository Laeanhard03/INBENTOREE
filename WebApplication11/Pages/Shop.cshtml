@page
@model WebApplication11.Pages.ShopModel
@{
    ViewData["Title"] = Model.StoreInfo?.StoreName ?? "Marketplace";
    var themeColor = Model.StoreInfo?.ThemeColor ?? "#4f46e5";
    var iconDataList = new[] {
        new { Color = "text-indigo-600", BgColor = "bg-indigo-100", Path = "M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4zM3.8 6h16.4M15 10a3 3 0 1 1-6 0" },
        new { Color = "text-green-600", BgColor = "bg-green-100", Path = "M12 20H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v6m-4 4h4a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8" },
        new { Color = "text-blue-600", BgColor = "bg-blue-100", Path = "M18 10h-2M2 14v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2M4 10a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-4z" },
        new { Color = "text-yellow-600", BgColor = "bg-yellow-100", Path = "M6.5 1h11a.5.5 0 0 1 .5.5v11.5L12 18.5 6 13V1.5a.5.5 0 0 1 .5-.5z" }
    };
    var iconCount = iconDataList.Length;
    var index = 0;
}

@Html.AntiForgeryToken()

@if (string.IsNullOrEmpty(Model.StoreId) || Model.StoreInfo == null || Model.StoreInfo.Id == null)
{
    <div class="text-center py-20">
        <h1 class="text-4xl font-bold text-gray-800">Welcome to Sari-Sari Marketplace</h1>
        <p class="text-gray-600 mt-2">Please use a valid store link to start shopping.</p>
    </div>
}
else
{
    @* --- SHARED HEADER --- *@
    <div class="bg-white shadow-sm border-b border-gray-100 mb-8 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-8">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight" style="color: @themeColor">@Model.StoreInfo.StoreName</h1>
                <p class="text-gray-500 mt-2 text-lg">@Model.StoreInfo.Description</p>
            </div>
            <div class="flex items-center gap-4">
                @if (Model.CurrentView == "shop")
                {

                    <button id="openFiltersBtn" class="flex items-center gap-2 text-white px-5 py-2.5 rounded-full shadow-md transition-transform hover:scale-105" style="background-color: @themeColor;">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                        <span>Search & Filter</span>
                    </button>
                }
                else
                {
                    <a href="/Shop?StoreId=@Model.StoreId" class="flex items-center gap-2 bg-gray-100 text-gray-700 px-5 py-2.5 rounded-full hover:bg-gray-200 transition">
                        <span>&larr; Back to Shop</span>
                    </a>
                }
            </div>
        </div>
    </div>

    @* --- VIEW SWITCHING --- *@

    @if (Model.CurrentView == "cart")
    {
        @* === CART VIEW === *@
        <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden my-8">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="font-bold text-2xl text-gray-800">My Bayong (Cart)</h2>
                    <span class="font-semibold text-gray-600">@Model.CartItems.Sum(i => i.Quantity) Items</span>
                </div>

                @if (Model.CartItems.Count == 0)
                {
                    <div class="text-center py-10">
                        <p class="text-gray-500 mb-4">Your bayong is empty!</p>
                        <a href="/Shop?StoreId=@Model.StoreId" class="inline-block bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700">Go Shopping</a>
                    </div>
                }
                else
                {
                    <div class="space-y-4">
                        @foreach (var item in Model.CartItems)
                        {
                            <div class="flex items-center justify-between border-b pb-4">
                                <div>
                                    <h3 class="font-bold text-sm text-gray-800">@item.ItemName</h3>
                                    <p class="text-xs text-gray-500">Price: <span class="price-display" data-price-php="@item.Price">₱@item.Price</span></p>
                                </div>
                                <div class="flex items-center gap-6">
                                    <span class="text-sm font-semibold">x @item.Quantity</span>
                                    <span class="text-lg font-bold text-indigo-700 price-display" data-price-php="@item.Total">₱@item.Total</span>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="mt-8 border-t pt-6 flex flex-col items-end">
                        <div class="flex justify-between w-full md:w-1/2 mb-4">
                            <span class="font-semibold text-gray-600 uppercase">Total Cost</span>
                            <span class="font-bold text-2xl text-indigo-700 price-display" data-price-php="@Model.GrandTotal">₱@Model.GrandTotal</span>
                        </div>
                        <form method="post" asp-page-handler="Checkout">
                            <input type="hidden" name="StoreId" value="@Model.StoreId" />
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-10 rounded-lg shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                                <span>Checkout & Get QR</span>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </button>
                        </form>
                    </div>
                }
            </div>
        </div>
    }
    else if (Model.CurrentView == "receipt" && Model.ReceiptOrder != null)
    {
        @* === RECEIPT VIEW === *@
        <div class="max-w-md mx-auto bg-white p-10 rounded-xl shadow-2xl my-8">
            <div class="text-center">
                <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Order Confirmed!</h2>
                <p class="mt-2 text-sm text-gray-600">Show this QR code at the store.</p>
            </div>
            <div class="flex justify-center my-6">
                <div id="qrcode" class="p-2 bg-white border-4 border-gray-800 rounded-lg"></div>
            </div>
            <div class="text-center font-mono text-xl font-bold tracking-widest text-gray-800">@Model.ReceiptOrder.OrderCode</div>
            <div class="border-t border-b border-gray-200 py-4 my-4">
                <ul class="space-y-3">
                    @foreach (var item in Model.ReceiptOrder.Items)
                    {
                        <li class="flex justify-between text-sm">
                            <span class="text-gray-600">@item.Quantity x @item.ItemName</span>
                            <span class="font-semibold text-gray-900">₱@item.Total.ToString("N2")</span>
                        </li>
                    }
                </ul>
            </div>
            <div class="flex justify-between items-center mb-6">
                <span class="text-lg font-bold text-gray-900">Total Paid</span>
                <span class="text-2xl font-bold text-indigo-600">₱@Model.ReceiptOrder.TotalAmount.ToString("N2")</span>
            </div>
            <button onclick="window.print()" class="w-full bg-gray-800 text-white py-2 rounded-lg hover:bg-gray-900 font-medium print:hidden">Print Receipt</button>
        </div>
    }
    else
    {
        @* === SHOP VIEW (DEFAULT) === *@
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            @if (Model.Products.Count == 0)
            {
                <div class="col-span-full text-center py-20 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                    <p class="mt-2 text-xl font-medium text-gray-500">No products found here.</p>
                </div>
            }
            else
            {
                @foreach (var item in Model.Products)
                {
                    string base64Image = null;
                    bool hasImage = item.LogoData != null;
                    if (hasImage) { base64Image = $"data:{item.LogoContentType};base64,{Convert.ToBase64String(item.LogoData!)}"; }
                    var iconData = iconDataList[index % iconCount];

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl transition-all duration-300 group flex flex-col">
                        <div class="relative aspect-square @(hasImage ? "bg-gray-100" : iconData.BgColor) flex items-center justify-center overflow-hidden">
                            @if (hasImage)
                            {
                                <img src="@base64Image" alt="@item.Name" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                            }
                            else
                            {
                                <svg class="w-16 h-16 @iconData.Color" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="@iconData.Path"></path>
                                </svg>
                            }
                            @if (item.Quantity == 0)
                            {
                                <span class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded">SOLD OUT</span>
                            }
                            else if (item.Quantity < 5)
                            {

                                <span class="absolute top-2 right-2 bg-orange-400 text-white text-xs font-bold px-2 py-1 rounded">FEW LEFT</span>
                            }
                        </div>
                        <div class="p-4 flex flex-col flex-grow">
                            <h3 class="text-gray-900 font-semibold line-clamp-1">@item.Name</h3>

                            @* Clickable Category *@
                            <a href="/Shop?StoreId=@Model.StoreId&SearchTerm=@item.Category" class="text-xs text-indigo-500 mb-1 font-medium truncate hover:underline block" title="Filter by @item.Category">@item.Category</a>

                            <p class="text-xs text-gray-500 mb-3">@item.Quantity available</p>
                            <div class="mt-auto flex justify-between items-center gap-2">
                                <span class="text-lg font-bold price-display" data-price-php="@item.Price" style="color: @themeColor">$@item.Price.ToString("N2")</span>
                                <button onclick="openAddToCartModal('@item.Id', '@item.Name', @item.Price, @item.Quantity)" class="p-2 rounded-full text-white transition-colors hover:opacity-80 disabled:opacity-50" style="background-color: @themeColor;" @(item.Quantity == 0 ? "disabled" : "")>
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    index++;
                }
            }
        </div>

        @* --- ADD TO CART MODAL --- *@
        <div id="addToCartModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full relative">
                <button onclick="closeAddToCartModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                <h3 id="modalItemName" class="text-lg font-bold text-gray-800 mb-1">Item Name</h3>
                <p class="text-sm text-gray-500 mb-6">Price: <span id="modalItemPrice" class="font-bold text-indigo-600"></span></p>
                <div class="flex items-center justify-center gap-4 mb-6">
                    <button onclick="adjustQty(-1)" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 font-bold">-</button>
                    <input type="number" id="modalQty" value="1" min="1" class="w-16 text-center border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" readonly>
                    <button onclick="adjustQty(1)" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 font-bold">+</button>
                </div>
                <button onclick="confirmAddToCart()" class="w-full py-3 text-white rounded-lg font-bold hover:opacity-90 shadow-md transition-colors" style="background-color: @themeColor;">
                    Add to Cart
                </button>
            </div>
        </div>

        @* --- FILTER DRAWER --- *@
        <div id="filterDrawerOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden transition-opacity opacity-0"></div>
        <div id="filterDrawer" class="fixed inset-y-0 right-0 max-w-xs w-full bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold text-gray-800">Filter & Sort</h2>
                <button id="closeFiltersBtn" class="text-gray-500 hover:text-gray-700"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="flex-1 overflow-y-auto px-6 py-6">
                <form method="get" id="filterForm">
                    <input type="hidden" name="StoreId" value="@Model.StoreId" />
                    <div class="mb-6"><label class="block text-sm font-bold text-gray-700 mb-2">Search</label><input type="text" name="SearchTerm" value="@Model.SearchTerm" class="w-full rounded-lg border-gray-300 shadow-sm"></div>
                    <div class="mb-6"><label class="block text-sm font-bold text-gray-700 mb-2">Price Range</label><div class="flex gap-2"><input type="number" name="MinPrice" value="@Model.MinPrice" placeholder="Min" class="w-full rounded-lg border-gray-300 shadow-sm"><input type="number" name="MaxPrice" value="@Model.MaxPrice" placeholder="Max" class="w-full rounded-lg border-gray-300 shadow-sm"></div></div>
                </form>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex gap-3">
                <a href="/Shop?StoreId=@Model.StoreId" class="w-1/2 py-2 px-4 border border-gray-300 rounded-lg text-center text-gray-700 font-medium hover:bg-white transition-colors">Reset</a>
                <button type="submit" form="filterForm" class="w-1/2 py-2 px-4 bg-indigo-600 rounded-lg text-center text-white font-medium hover:bg-indigo-700 transition-colors" style="background-color: @themeColor;">Apply</button>
            </div>
        </div>
    }

    @* --- MESSENGER-STYLE CHAT WIDGET --- *@
    <div id="chatWidget" class="fixed bottom-6 right-6 z-50">
        <button onclick="toggleChat()" id="chatToggle" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-4 shadow-xl transition-transform hover:scale-110 flex items-center justify-center relative">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            <span class="absolute top-0 right-0 h-3 w-3 bg-green-400 rounded-full border-2 border-white"></span>
        </button>

        <div id="chatBox" class="hidden absolute bottom-20 right-0 w-[350px] bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col transition-all duration-300 border border-gray-100 h-[480px]">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-xl">👩‍💼</div>
                    <div>
                        <h3 class="font-bold text-sm">Sari Assistant</h3>
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                            <p class="text-xs opacity-90" id="chatStatus">AI Powered</p>
                        </div>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white hover:text-gray-200 bg-white bg-opacity-10 rounded-full p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>

            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                <div class="text-left animate-fade-in-up">
                    <span class="inline-block px-4 py-2 rounded-2xl rounded-tl-none bg-white text-gray-700 shadow-sm text-sm border border-gray-100">
                        Hello! 👋 I'm Sari. Ask me anything!
                    </span>
                </div>
            </div>

            <div class="p-3 bg-white border-t border-gray-100">
                <form id="chatForm" onsubmit="sendChatMessage(event)" class="flex gap-2 items-center">
                    <input type="text" id="chatInput" placeholder="Ask about items, prices, or seller..." class="flex-1 bg-gray-100 border-0 rounded-full px-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all">
                    <button type="submit" class="bg-indigo-600 text-white rounded-full p-2.5 hover:bg-indigo-700 transition shadow-md flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    @if (Model.CurrentView == "receipt")
    {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
        <script>
            new QRCode(document.getElementById("qrcode"), { text: "@Model.ReceiptOrder.Id", width: 128, height: 128 });
        </script>
    }

    <script>
        // ... (Keep existing drawer/modal scripts) ...
        const openBtn = document.getElementById('openFiltersBtn');
        const closeBtn = document.getElementById('closeFiltersBtn');
        const drawer = document.getElementById('filterDrawer');
        const overlay = document.getElementById('filterDrawerOverlay');
        if(openBtn) { openBtn.addEventListener('click', () => { overlay.classList.remove('hidden'); setTimeout(() => overlay.classList.remove('opacity-0'), 10); drawer.classList.remove('translate-x-full'); }); }
        if(closeBtn) {
            const close = () => { drawer.classList.add('translate-x-full'); overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 300); };
            closeBtn.addEventListener('click', close); overlay.addEventListener('click', close);
        }

        // --- NEW: CHAT WIDGET LOGIC ---
        let isChatOpen = false;
        let isHumanMode = false;
        let guestId = localStorage.getItem('sari_guest_id');
        if(!guestId) { guestId = 'guest_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('sari_guest_id', guestId); }
        const storeId = "@Model.StoreId";
        let previousMsgCount = 0; // Track message count to detect new ones

        function toggleChat() {
            const box = document.getElementById('chatBox');
            if(isChatOpen) {
                box.classList.add('hidden', 'opacity-0', 'translate-y-4');
                box.classList.remove('opacity-100', 'translate-y-0');
            } else {
                box.classList.remove('hidden');
                setTimeout(() => {
                    box.classList.remove('opacity-0', 'translate-y-4');
                    box.classList.add('opacity-100', 'translate-y-0');
                }, 10);
                // Check on open
                checkForExistingChat();
            }
            isChatOpen = !isChatOpen;
        }

        // Auto-check on load (runs once)
        document.addEventListener('DOMContentLoaded', () => {
            checkForExistingChat();
        });

        async function checkForExistingChat() {
            const res = await fetch(`/Shop?handler=CheckMessages&storeId=${storeId}&guestId=${guestId}`);
            const data = await res.json();
            if(data.messages && data.messages.length > 0) {
                isHumanMode = true; // Force human mode if history exists
                document.getElementById('chatStatus').textContent = "Chatting with Seller";
                renderFullChat(data.messages);
                startPolling(); // Ensure polling is active
            }
        }

        function renderFullChat(msgs) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = ''; // Clear to rebuild
            msgs.forEach(m => {
                const type = m.sender === 'User' ? 'user' : 'ai'; // 'Seller' maps to 'ai' style for alignment
                addMessage(m.content, type);
            });
            previousMsgCount = msgs.length;
        }

        async function sendChatMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const msgText = input.value.trim();
            if(!msgText) return;

            addMessage(msgText, 'user');
            input.value = '';

            if(!isHumanMode) {
                // AI Mode
                addTypingIndicator();
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const formData = new FormData();
                formData.append('input', msgText);
                formData.append('storeId', storeId);
                formData.append('guestId', guestId);

                const res = await fetch('/Shop?handler=AiChat', { method: 'POST', body: formData, headers: {'RequestVerificationToken': token} });
                const data = await res.json();

                removeTypingIndicator();
                addMessage(data.reply, 'ai');

                if(data.handoff) {
                    isHumanMode = true;
                    document.getElementById('chatStatus').textContent = "Chatting with Seller";
                    startPolling();
                }
            } else {
                // Live Mode
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const formData = new FormData();
                formData.append('storeId', storeId);
                formData.append('guestId', guestId);
                formData.append('content', msgText);
                await fetch('/Shop?handler=SendUserMessage', { method: 'POST', body: formData, headers: {'RequestVerificationToken': token} });
                // Note: Polling picks up the echo or we can add manually. Polling is safer for consistency.
            }
        }

        function addMessage(text, type) {
            const container = document.getElementById('chatMessages');
            const align = type === 'user' ? 'justify-end' : 'justify-start';
            const bg = type === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none border border-gray-100';

            const div = document.createElement('div');
            div.className = `flex ${align} animate-fade-in-up`;
            div.innerHTML = `<span class="inline-block px-4 py-2.5 rounded-2xl shadow-sm text-sm ${bg} max-w-[85%] break-words leading-relaxed">${text}</span>`;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.id = 'typingIndicator';
            div.className = 'flex justify-start animate-fade-in-up';
            div.innerHTML = `<span class="inline-block px-4 py-3 rounded-2xl rounded-tl-none bg-white border border-gray-100 shadow-sm"><div class="flex space-x-1"><div class="w-2 h-2 bg-gray-300 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.2s"></div><div class="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.4s"></div></div></span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const el = document.getElementById('typingIndicator');
            if(el) el.remove();
        }

        let pollInterval;
        function startPolling() {
            if(pollInterval) return;
            pollInterval = setInterval(async () => {
                const res = await fetch(`/Shop?handler=CheckMessages&storeId=${storeId}&guestId=${guestId}`);
                const data = await res.json();

                // If message count increased, RE-RENDER ALL (Simple & Robust)
                if(data.messages && data.messages.length > previousMsgCount) {
                    renderFullChat(data.messages);
                }
            }, 3000);
        }

        // --- EXISTING ADD TO CART ---
        let selectedItemId = null;
        let maxQty = 1;

        function openAddToCartModal(id, name, price, stock) {
            selectedItemId = id;
            maxQty = stock;
            document.getElementById('modalItemName').textContent = name;
            document.getElementById('modalItemPrice').textContent = '₱' + price.toFixed(2);
            document.getElementById('modalQty').value = 1;
            document.getElementById('addToCartModal').classList.remove('hidden');
        }

        function closeAddToCartModal() { document.getElementById('addToCartModal').classList.add('hidden'); }

        function adjustQty(amount) {
            const input = document.getElementById('modalQty');
            let newVal = parseInt(input.value) + amount;
            if(newVal < 1) newVal = 1;
            if(newVal > maxQty) newVal = maxQty;
            input.value = newVal;
        }

        async function confirmAddToCart() {
            closeAddToCartModal();
            const qty = document.getElementById('modalQty').value;
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            try {
                const response = await fetch(`/Shop?handler=AddToCart&itemId=${selectedItemId}&quantity=${qty}`, { method: 'POST', headers: { 'RequestVerificationToken': token } });
                if(response.ok) {
                    const data = await response.json();
                    if(data.success) {
                        const badge = document.getElementById('cartCount');
                        if(badge) { badge.textContent = data.count; badge.classList.remove('hidden'); }

                        let toast = document.getElementById('toast-notification');
                        if (!toast) {
                            toast = document.createElement('div');
                            toast.id = 'toast-notification';
                            toast.className = 'fixed top-1/2 left-1/2 z-50 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none';
                            document.body.appendChild(toast);
                        }
                        toast.textContent = `Added ${qty} item(s) to Cart! 🛒`;
                        toast.className = 'fixed top-1/2 left-1/2 z-50 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl transition-opacity duration-300';
                        setTimeout(() => { toast.style.opacity = '1'; }, 10);
                        setTimeout(() => { toast.style.opacity = '0'; }, 1500);
                    }
                }
            } catch (err) { console.error(err); alert("Failed to add to cart."); }
        }
    </script>
}