@page
@model WebApplication11.Pages.IndexModel
@{
    ViewData["Title"] = "Login";
}
@Html.AntiForgeryToken()
<style>
    /* MODIFIED: Hide register AND verify forms by default */
    #registerForm, #verifyCodeForm {
        display: none;
    }
    /* Style for the global message box */
    #globalMessage {
        display: none; /* Hidden by default */
    }
    /* NEW: Style for the resend button */
    #resendCodeBtn {
        background: none;
        border: none;
        padding: 0;
        font-size: 0.875rem; /* text-sm */
        color: #4f46e5; /* indigo-600 */
        cursor: pointer;
    }

        #resendCodeBtn:hover {
            color: #3730a3; /* indigo-800 */
        }

        #resendCodeBtn:disabled {
            color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
</style>

<div class="flex items-center justify-center min-h-screen bg-gray-100">
    <div class="w-full max-w-md">

        <!-- RENAMED: from #globalError to #globalMessage -->
        <div id="globalMessage" class="border px-4 py-3 rounded-lg relative mb-4" role="alert">
            <strong class="font-bold" id="globalMessageTitle">Error:</strong>
            <span class="block sm:inline" id="globalMessageText">Something went wrong.</span>
        </div>

        <!-- --- Form 1: Login --- -->
        <form id="loginForm" method="post" asp-page-handler="Login" class="bg-white shadow-2xl rounded-xl px-8 pt-6 pb-8 mb-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Inventory Login</h2>

            <div asp-validation-summary="ModelOnly" class="text-red-600 text-sm mb-4"></div>

            <div class="mb-4">
                <label asp-for="LoginInput.UsernameOrEmail" class="block text-gray-700 text-sm font-bold mb-2"></label>
                <input asp-for="LoginInput.UsernameOrEmail" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Username or Email" required />
            </div>
            <div class="mb-6">
                <label asp-for="LoginInput.Password" class="block text-gray-700 text-sm font-bold mb-2"></label>
                <div class="relative">
                    <input asp-for="LoginInput.Password" type="password" class="shadow-sm appearance-none border rounded-lg
w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 pr-10"
                           placeholder="******************" required />
                    <button type="button" class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-indigo-600" aria-label="Show password">
                        <svg class="h-5 w-5 eye-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-.07.207-.141.414-.216.62M16.5 10.5V12a4.5 4.5 0 01-4.5 4.5h-0" />
                        </svg>
                        <svg class="h-5 w-5 eye-slash-icon hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .175-.484.372-.954.59-1.405M14.121 14.121A3 3 0 0112 15a3 3 0 01-2.121-.879M6.879 6.879A3 3 0 019 6a3 3 0 012.121.879m0 0A4.5 4.5 0 0112 9a4.5 4.5 0 012.121 2.121M3.458 5.657A10.03 10.03 0 0112 5c4.478 0 8.268 2.943 9.542 7-.175.484-.372.954-.59 1.405M12 12a2.989 2.989 0 00-2.121.879l-1.061 1.061" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <button type="submit" id="loginSubmitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-150 disabled:opacity-50">
                    Sign In
                </button>
            </div>
            <p class="text-center text-gray-500 text-sm mt-6">
                Don't have an account?
                <a href="#" id="showRegister" class="font-bold text-indigo-600 hover:text-indigo-800">
                    Register here
                </a>
            </p>
        </form>

        <!-- --- Form 2: Register --- -->
        <form id="registerForm" method="post" asp-page-handler="Register" class="bg-white shadow-2xl rounded-xl px-8 pt-6 pb-8 mb-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Create Account</h2>

            <div asp-validation-summary="ModelOnly" class="text-red-600 text-sm mb-4"></div>

            <div class="mb-4">
                <label asp-for="RegisterInput.Username" class="block text-gray-700 text-sm font-bold mb-2"></label>
                <input asp-for="RegisterInput.Username" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Choose a username" required />
                <span asp-validation-for="RegisterInput.Username" class="text-red-600 text-xs"></span>
            </div>

            <div class="mb-4">
                <label asp-for="RegisterInput.Email" class="block text-gray-700 text-sm font-bold mb-2"></label>
                <input asp-for="RegisterInput.Email" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., user@example.com" required />
                <span asp-validation-for="RegisterInput.Email" class="text-red-600 text-xs"></span>
            </div>
            <div class="mb-4">
                <label asp-for="RegisterInput.ConfirmEmail" class="block text-gray-700 text-sm font-bold mb-2"></label>
                <input asp-for="RegisterInput.ConfirmEmail" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Confirm your email" required />
                <span asp-validation-for="RegisterInput.ConfirmEmail" class="text-red-600 text-xs"></span>
            </div>
            <div class="mb-4">
                <label asp-for="RegisterInput.Password" class="block text-gray-700 text-sm font-bold mb-2"></label>
                <div class="relative">
                    <input asp-for="RegisterInput.Password" type="password" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 pr-10" placeholder="Create a password" required />
                    <button type="button" class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-green-600" aria-label="Show password">
                        <svg class="h-5 w-5 eye-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-.07.207-.141.414-.216.62M16.5 10.5V12a4.5 4.5 0 01-4.5 4.5h-0" />
                        </svg>
                        <svg class="h-5 w-5 eye-slash-icon hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .175-.484-.372-.954.59-1.405M14.121 14.121A3 3 0 0112 15a3 3 0 01-2.121-.879M6.879 6.879A3 3 0 019 6a3 3 0 012.121.879m0 0A4.5 4.5 0 0112 9a4.5 4.5 0 012.121 2.121M3.458 5.657A10.03 10.03 0 0112 5c4.478 0 8.268 2.943 9.542 7-.175.484-.372.954-.59 1.405M12 12a2.989 2.989 0 00-2.121.879l-1.061 1.061" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />
                        </svg>
                    </button>
                </div>
                <span asp-validation-for="RegisterInput.Password" class="text-red-600 text-xs"></span>
            </div>
            <div class="mb-6">
                <label asp-for="RegisterInput.ConfirmPassword" class="block text-gray-700 text-sm font-bold mb-2"></label>
                <div class="relative">
                    <input asp-for="RegisterInput.ConfirmPassword" type="password" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500 pr-10" placeholder="Confirm your password" required />
                    <button type="button" class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-green-600" aria-label="Show password">
                        <svg class="h-5 w-5 eye-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-.07.207-.141.414-.216.62M16.5 10.5V12a4.5 4.5 0 01-4.5 4.5h-0" />
                        </svg>
                        <svg class="h-5 w-5 eye-slash-icon hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .175-.484-.372-.954.59-1.405M14.121 14.121A3 3 0 0112 15a3 3 0 01-2.121-.879M6.879 6.879A3 3 0 019 6a3 3 0 012.121.879m0 0A4.5 4.5 0 0112 9a4.5 4.5 0 012.121 2.121M3.458 5.657A10.03 10.03 0 0112 5c4.478 0 8.268 2.943 9.542 7-.175.484-.372.954-.59 1.405M12 12a2.989 2.989 0 00-2.121.879l-1.061 1.061" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />
                        </svg>
                    </button>
                </div>
                <span asp-validation-for="RegisterInput.ConfirmPassword" class="text-red-600 text-xs"></span>
            </div>

            <div class="flex items-center justify-between">
                <button type="submit" id="registerSubmitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-150 disabled:opacity-50">
                    Register
                </button>
            </div>
            <p class="text-center text-gray-500 text-sm mt-6">
                Already have an account?
                <a href="#" id="showLogin" class="font-bold text-indigo-600 hover:text-indigo-800">
                    Login here
                </a>
            </p>
        </form>

        <!-- --- NEW Form 3: Verification Code --- -->
        <form id="verifyCodeForm" method="post" asp-page-handler="VerifyCode" class="bg-white shadow-2xl rounded-xl px-8 pt-6 pb-8 mb-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Check Your Email</h2>

            <p class="text-center text-gray-600 text-sm mb-6">
                We sent a 6-digit verification code to
                <strong id="verificationEmailDisplay" class="text-gray-900">your-email@example.com</strong>.
            </p>

            <!-- Hidden input to send the email -->
            <input type="hidden" asp-for="VerifyInput.Email" id="verify_email" />

            <div class="mb-4">
                <label asp-for="VerifyInput.Code" class="block text-gray-700 text-sm font-bold mb-2"></label>
                <input asp-for="VerifyInput.Code" id="verify_code" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="123456" required maxlength="6" />
                <span asp-validation-for="VerifyInput.Code" class="text-red-600 text-xs"></span>
            </div>

            <div class="flex items-center justify-between mb-6">
                <button type="submit" id="verifySubmitBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-150 disabled:opacity-50">
                    Verify Account
                </button>
            </div>

            <div class="flex justify-between items-center text-sm">
                <button type="button" id="resendCodeBtn" class="font-bold">Resend Code</button>
                <a href="#" id="showLoginFromVerify" class="font-bold text-indigo-600 hover:text-indigo-800">
                    Back to Login
                </a>
            </div>
        </form>
        <!-- --- END NEW Form --- -->


        <p class="text-center text-gray-500 text-xs">
            &copy;2025 Inventory Corp. All rights reserved.
        </p>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function() {
                // --- Setup password toggles ---
                setupPasswordToggles();

                // --- Form Elements ---
                const loginForm = document.getElementById('loginForm');
                const registerForm = document.getElementById('registerForm');
                const verifyCodeForm = document.getElementById('verifyCodeForm'); // NEW

                // --- Buttons ---
                const loginSubmitBtn = document.getElementById('loginSubmitBtn');
                const registerSubmitBtn = document.getElementById('registerSubmitBtn');
                const verifySubmitBtn = document.getElementById('verifySubmitBtn'); // NEW
                const resendCodeBtn = document.getElementById('resendCodeBtn'); // NEW

                // --- Form Toggles ---
                document.getElementById('showRegister').addEventListener('click', (e) => { e.preventDefault(); showForm('registerForm'); });
                document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); showForm('loginForm'); });
                document.getElementById('showLoginFromVerify').addEventListener('click', (e) => { e.preventDefault(); showForm('loginForm'); }); // NEW

                // --- Global Message Box ---
                const globalMessageDiv = document.getElementById('globalMessage');
                const globalMessageTitle = document.getElementById('globalMessageTitle');
                const globalMessageText = document.getElementById('globalMessageText');

                // --- Hidden Fields ---
                const verifyEmailInput = document.getElementById('verify_email'); // NEW
                const verificationEmailDisplay = document.getElementById('verificationEmailDisplay'); // NEW

                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                // --- NEW: Helper function to switch forms ---
                function showForm(formId) {
                    // Hide all forms
                    loginForm.style.display = 'none';
                    registerForm.style.display = 'none';
                    verifyCodeForm.style.display = 'none';

                    // Hide the global message
                    globalMessageDiv.style.display = 'none';

                    // Show the requested form
                    document.getElementById(formId).style.display = 'block';
                }

                // 1. Handle Login Submission
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    setLoading(loginSubmitBtn, 'Signing In...');

                    try {
                        const response = await fetch('/Index?handler=Login', {
                            method: 'POST',
                            body: new FormData(loginForm),
                            headers: { 'X-Request-Verification-Token': token }
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            window.location.href = result.redirectUrl;
                        } else {
                            // --- MODIFIED: Check if verification is needed ---
                            if (result.needsVerification) {
                                // User needs to verify. Switch to verify form.
                                verifyEmailInput.value = result.email;
                                verificationEmailDisplay.textContent = result.email;
                                showForm('verifyCodeForm');
                                // Show the server message (e.g., "Code was sent")
                                showMessage(result.message || 'Verification required.', 'error');
                            } else {
                                // Standard login error
                                showMessage(result.message || 'An unknown error occurred.', 'error');
                            }
                            setLoading(loginSubmitBtn, 'Sign In', false);
                        }
                    } catch (error) {
                        showMessage('Could not connect to the server. Please try again.', 'error');
                        setLoading(loginSubmitBtn, 'Sign In', false);
                    }
                });

                // 2. Handle Register Submission
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    setLoading(registerSubmitBtn, 'Registering...');

                    try {
                        const response = await fetch('/Index?handler=Register', {
                            method: 'POST',
                            body: new FormData(registerForm),
                            headers: { 'X-Request-Verification-Token': token }
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            // --- MODIFIED: Check for verification ---
                            if (result.needsVerification) {
                                // Success! Switch to verification form.
                                verifyEmailInput.value = result.email;
                                verificationEmailDisplay.textContent = result.email;
                                showForm('verifyCodeForm');
                                // Show a SUCCESS message
                                showMessage('Registration successful! Please check your email for a verification code.', 'success');
                            } else {
                                // (Shouldn't happen with new flow, but good practice)
                                window.location.href = result.redirectUrl;
                            }
                        } else {
                            // Registration failed
                            showMessage(result.message || 'An unknown error occurred.', 'error');
                            setLoading(registerSubmitBtn, 'Register', false);
                        }
                    } catch (error) {
                        showMessage('Could not connect to the server. Please try again.', 'error');
                        setLoading(registerSubmitBtn, 'Register', false);
                    }
                });

                // --- NEW: 3. Handle Code Verification Submission ---
                verifyCodeForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    setLoading(verifySubmitBtn, 'Verifying...');

                    try {
                        const response = await fetch('/Index?handler=VerifyCode', {
                            method: 'POST',
                            body: new FormData(verifyCodeForm),
                            headers: { 'X-Request-Verification-Token': token }
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            // Success! Redirect to dashboard
                            window.location.href = result.redirectUrl;
                        } else {
                            // Failed (e.g., wrong code)
                            showMessage(result.message || 'Verification failed.', 'error');
                            setLoading(verifySubmitBtn, 'Verify Account', false);
                        }
                    } catch (error) {
                        showMessage('Could not connect to the server. Please try again.', 'error');
                        setLoading(verifySubmitBtn, 'Verify Account', false);
                    }
                });

                // --- NEW: 4. Handle Resend Code Click ---
                resendCodeBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    setLoading(resendCodeBtn, 'Sending...');

                    const emailToResend = verifyEmailInput.value;
                    if (!emailToResend) {
                        showMessage('Could not find email to resend code.', 'error');
                        setLoading(resendCodeBtn, 'Resend Code', false);
                        return;
                    }

                    // We must use FormData to send the email and the token
                    const formData = new FormData();
                    formData.append('email', emailToResend);

                    try {
                        const response = await fetch('/Index?handler=ResendCode', {
                            method: 'POST',
                            body: formData, // Send email as form data
                            headers: { 'X-Request-Verification-Token': token }
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            showMessage('A new code has been sent to your email.', 'success');
                        } else {
                            showMessage(result.message || 'Failed to resend code.', 'error');
                        }
                    } catch (error) {
                         showMessage('Could not connect to the server.', 'error');
                    }

                    setLoading(resendCodeBtn, 'Resend Code', false);
                });


                // --- Helper Functions ---

                function setLoading(button, text, disabled = true) {
                    button.disabled = disabled;
                    button.textContent = text;
                }

                // MODIFIED: 'type' can be 'error' or 'success'
                function showMessage(message, type = 'error') {
                    globalMessageText.textContent = message;

                    // Reset classes
                    globalMessageDiv.classList.remove('bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700');

                    if (type === 'error') {
                        globalMessageTitle.textContent = 'Error:';
                        globalMessageDiv.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    } else {
                        globalMessageTitle.textContent = 'Success:';
                        globalMessageDiv.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    }

                    globalMessageDiv.style.display = 'block';
                }

                function setupPasswordToggles() {
                    document.querySelectorAll('.password-toggle').forEach(button => {
                        button.addEventListener('click', function () {
                            // Find the input field right before this button
                            const input = this.previousElementSibling;
                            const eyeIcon = this.querySelector('.eye-icon');
                            const eyeSlashIcon = this.querySelector('.eye-slash-icon');

                            if (input.type === 'password') {
                                input.type = 'text';
                                eyeIcon.classList.add('hidden');
                                eyeSlashIcon.classList.remove('hidden');
                            } else {
                                input.type = 'password';
                                eyeIcon.classList.remove('hidden');
                                eyeSlashIcon.classList.add('hidden');
                            }
                        });
                    });
                }
        });
    </script>
}