@page
@model WebApplication11.Pages.ReportsModel
@{
    ViewData["Title"] = "Business Analytics";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .pdf-bg-white {
        background-color: #ffffff !important;
    }

    /* PDF Appendix: Hidden on screen, Visible in PDF */
    #pdf-appendix {
        display: none;
    }

    .show-in-pdf #pdf-appendix {
        display: block;
        margin-top: 2rem;
        border-top: 2px dashed #ccc;
        padding-top: 2rem;
    }

    /* --- PDF LAYOUT FIXES (STACKED APPROACH) --- */
    .pdf-mode {
        width: 800px !important;
        /* Standard Page Width */
        margin: 0 auto;
        background-color: white;
        padding: 30px !important;
        height: auto !important; /* ADDED: Allows full height expansion */
        overflow: visible !important; /* ADDED: Ensure no clipping */
    }

        /* Force Vertical Stacking in PDF to prevent cutoff */
        .pdf-mode .pdf-grid-stack {
            display: block !important;
            width: 100% !important;
        }

        /* Make columns full width in PDF */
        .pdf-mode .pdf-col-full {
            width: 100% !important;
            max-width: 100% !important;
            margin-bottom: 2rem !important;
            flex: none !important;
        }

        /* Adjust Chart Sizes for PDF */
        .pdf-mode canvas {
            max-height: 300px !important;
            width: 100% !important;
        }

        /* Hide interactive toggles in PDF */
        .pdf-mode .chart-toggle-container {
            display: none !important;
        }

        /* Prevent charts/cards from being sliced in half */
        .pdf-mode .bg-white,
        .pdf-mode .rounded-xl {
            page-break-inside: avoid;
        }

    /* Toggle Button Styles */
    .chart-toggle.active {
        background-color: #ffffff;
        color: #4f46e5;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .chart-toggle {
        color: #6b7280;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 700;
        transition: all 0.2s;
    }

        .chart-toggle:hover {
            color: #4f46e5;
        }
</style>

<div class="space-y-6">

    @* --- TOP HEADER (Excluded from PDF) --- *@
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-2xl shadow-sm border border-gray-100" data-html2canvas-ignore="true">
        <div>
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Business Insights</h1>
            <p class="text-sm text-gray-500 mt-1">
                @if (Model.LastAnalysisDate.HasValue)
                {
                    <span class="text-green-600 font-medium">Last analyzed: @Model.LastAnalysisDate.Value.ToLocalTime().ToString("MMM dd, hh:mm tt")</span>
                }
                else
                {

                    <span class="text-orange-500">No analysis data yet.</span>
                }
            </p>
        </div>
        <div class="mt-4 md:mt-0 flex flex-col md:flex-row gap-3 items-center">
            <form method="post" asp-page-handler="Analyze"><button type="submit" class="group relative inline-flex items-center justify-center px-5 py-2 text-sm font-bold text-white transition-all duration-200 bg-indigo-600 rounded-full focus:outline-none hover:bg-indigo-700 shadow-md"><span>Re-Analyze (AI)</span></button></form>
            <button onclick="downloadPdf()"
                    class="group relative inline-flex items-center justify-center px-5 py-2 text-sm font-bold text-gray-700 transition-all duration-200 bg-white border-2 border-gray-200 rounded-full hover:bg-gray-50 hover:text-indigo-600 shadow-sm">
                <span>Download Report</span>
            </button>
            <form method="post" asp-page-handler="SeedHistory" onsubmit="return confirm('Generate random data?
                This creates 90 days of history.');">
                <button type="submit" class="text-gray-500 hover:text-gray-700 text-sm font-medium underline ml-2">🎲 Gen Data</button>
            </form>
        </div>
    </div>

    @* --- REPORT CONTENT (Captures for PDF) --- *@
    <div id="report-content" class="p-2 md:p-4 pdf-bg-white space-y-6">

        @* Title Header *@
        <div class="border-b-2 border-indigo-900 pb-4">
            <div class="flex justify-between items-end">

                <div><h1 class="text-4xl font-extrabold text-gray-900">Performance Report</h1><p class="text-gray-500 mt-1">Generated: @DateTime.Now.ToString("MMMM dd, yyyy")</p></div>
                <div class="text-right"><h2 class="text-xl font-bold text-indigo-700">Sari-Sari Store</h2></div>
            </div>
        </div>

        @* KPI Cards *@
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white p-5 rounded-xl border-l-4 border-indigo-600 shadow-sm ring-1 ring-gray-100">
                <p class="text-xs font-bold text-gray-400 uppercase">Total Revenue</p>
                <h2 class="text-2xl font-extrabold text-gray-900 mt-1 price-display" data-price-php="@Model.TotalRevenue">₱@Model.TotalRevenue.ToString("N2")</h2>
            </div>
            <div class="bg-white p-5 rounded-xl border-l-4 border-emerald-500 shadow-sm ring-1 ring-gray-100">
                <p class="text-xs font-bold text-gray-400 uppercase">Net Profit</p>
                <h2 class="text-2xl font-extrabold text-emerald-600 mt-1 price-display" data-price-php="@Model.TotalProfit">₱@Model.TotalProfit.ToString("N2")</h2>
            </div>
            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-5 rounded-xl border-l-4 border-purple-900 shadow-lg text-white">
                <p class="text-xs font-bold text-indigo-200 uppercase">AI Prediction (7 Days)</p>
                <h2 class="text-2xl font-extrabold mt-2 price-display" data-price-php="@Model.ForecastedRevenue">₱@Model.ForecastedRevenue.ToString("N2")</h2>
            </div>
            <div class="bg-white p-5 rounded-xl border-l-4 border-red-500 shadow-sm ring-1 ring-gray-100">
                <p class="text-xs font-bold text-gray-400 uppercase">Restock Needed</p>
                <h2 class="text-2xl font-extrabold text-red-600 mt-1">@Model.LowStockItems.Count</h2>
            </div>
        </div>

        @* --- MAIN CONTENT (STACKED IN PDF) --- *@
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 pdf-grid-stack">

            @* --- LEFT COLUMN: Charts --- *@
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100 pdf-col-full">

                @* 1. SALES CHART *@
                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="text-lg font-bold text-gray-800">Sales Trend</h3>
                        <div class="bg-gray-100 p-1 rounded-lg flex chart-toggle-container" data-html2canvas-ignore="true">
                            <button onclick="updateSalesChart('daily')" id="btn-sales-daily"
                                    class="chart-toggle active">
                                Daily
                            </button>
                            <button onclick="updateSalesChart('monthly')" id="btn-sales-monthly" class="chart-toggle">Monthly</button>
                            <button onclick="updateSalesChart('quarterly')" id="btn-sales-quarterly" class="chart-toggle">Quarterly</button>
                        </div>
                    </div>
                    <div class="h-64 w-full relative overflow-hidden">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                @* 2. REVENUE BY CATEGORY *@
                <div class="pt-8 mt-8 border-t border-gray-100">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2"><span class="text-xl">📊</span> Revenue by Category</h3>
                        <div class="bg-gray-100 p-1 rounded-lg flex chart-toggle-container" data-html2canvas-ignore="true">
                            <button onclick="updateCategoryChart('all')" id="btn-cat-all" class="chart-toggle active">All Time</button>
                            <button onclick="updateCategoryChart('month')" id="btn-cat-month" class="chart-toggle">This Month</button>
                            <button onclick="updateCategoryChart('quarter')" id="btn-cat-quarter" class="chart-toggle">This Quarter</button>
                        </div>
                    </div>
                    <div class="h-64 w-full flex justify-center items-center relative overflow-hidden">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                @* 3. TOP PERFORMERS *@
                <div class="pt-8 mt-8 border-t border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4">🏆 Top Performers</h3>
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-400 uppercase bg-white border-b"><tr><th class="py-2">Product</th><th class="py-2 w-1/3">Performance</th><th class="py-2 text-right">Revenue</th></tr></thead>
                        <tbody class="divide-y
                            divide-gray-50">
                            @foreach (var item in Model.TopSellingItems)
                            {
                                var max = Model.TopSellingItems.Max(x => x.QuantitySold);
                                var width = max > 0 ? (item.QuantitySold / (double)max) * 100 : 0;
                                <tr>
                                    <td class="py-3 font-medium text-gray-800">@item.Name</td>
                                    <td class="py-3"><div class="flex items-center gap-3"><span class="text-xs font-bold w-6 text-right">@item.QuantitySold</span><div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-indigo-500 h-2 rounded-full" style="width: @width%"></div></div></div></td>
                                    <td class="py-3 text-right font-mono text-gray-600 price-display" data-price-php="@item.TotalRevenue">₱@item.TotalRevenue.ToString("N0")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            @* --- RIGHT COLUMN: Sidebar (Stacks BELOW in PDF) --- *@
            <div class="space-y-6 pdf-col-full">
                <div class="bg-purple-50 p-6 rounded-xl border border-purple-100 relative z-10">
                    <div class="flex items-center gap-2 mb-3"><span class="text-xl">📅</span><h3 class="font-bold text-purple-900">Sari's Event Radar</h3></div>
                    <p class="text-sm text-purple-800 leading-relaxed">@Model.HolidayPrediction</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative z-10">
                    <h3 class="font-bold text-gray-800 mb-4">Action Plan</h3>
                    <ul class="space-y-3">
                        @foreach (var tip in Model.ActionableTips)
                        {
                            <li class="flex items-start gap-3 text-sm text-gray-600"><span class="mt-1 w-1.5 h-1.5 rounded-full bg-indigo-500 flex-shrink-0"></span>@tip</li>
                        }
                    </ul>
                </div>

                @* Slow Moving Items *@
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden relative z-10">
                    <div class="px-6 py-4 border-b border-gray-50 bg-gray-50 flex justify-between items-center"><h3 class="font-bold text-gray-800">Slow Moving</h3><span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">Discount?</span></div>
                    <table class="w-full text-left text-sm text-gray-600">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-400 font-medium"><tr><th class="px-6 py-3">Item</th><th class="px-6 py-3 text-center">Stock</th></tr></thead>
                        <tbody class="divide-y divide-gray-50">
                            @if (Model.SlowMovingItems.Count == 0)
                            {
                                <tr><td colspan="2" class="px-6 py-8 text-center text-gray-400">No stagnant stock.</td></tr>
                            }
                            else
                            {
                                foreach (var item in Model.SlowMovingItems)
                                {
                                    <tr class="hover:bg-gray-50 transition"><td class="px-6 py-4 font-medium text-gray-900">@item.Name</td><td class="px-6 py-4 text-center">@item.Quantity</td></tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        @* --- PDF APPENDIX --- *@
        <div id="pdf-appendix">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-2">Detailed Period Analysis</h2>

            <div class="grid grid-cols-2 gap-8">
                <div class="bg-gray-50 p-4 rounded-xl">
                    <h3 class="font-bold text-gray-700 mb-4">Monthly Performance</h3>
                    <table class="w-full text-xs text-left">
                        <thead class="uppercase text-gray-400 font-bold border-b"><tr><th class="py-2">Month</th><th class="py-2 text-right">Revenue</th></tr></thead>
                        <tbody>
                            @foreach (var m in Model.MonthlyStats)
                            {
                                <tr class="border-b border-gray-100"><td class="py-2 font-medium">@m.Label</td><td class="py-2 text-right price-display" data-price-php="@m.Total">₱@m.Total.ToString("N2")</td></tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl">
                    <h3 class="font-bold text-gray-700 mb-4">Quarterly Performance</h3>
                    <table class="w-full text-xs text-left">
                        <thead class="uppercase text-gray-400 font-bold border-b"><tr><th class="py-2">Quarter</th><th class="py-2 text-right">Revenue</th></tr></thead>

                        <tbody>
                            @foreach (var q in Model.QuarterlyStats)
                            {
                                <tr class="border-b border-gray-100">
                                    <td class="py-2 font-medium">@q.Label</td>
                                    <td class="py-2 text-right price-display"
                                        data-price-php="@q.Total">
                                        ₱@q.Total.ToString("N2")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-6 text-center text-xs text-gray-400">
                Data exported from Sari-Sari Command Center on @DateTime.Now.ToString()
            </div>
        </div>

    </div>
</div>

<script>
    const salesDataStore = {
        daily: { labels: @Html.Raw(Model.SalesChartLabels), data: @Html.Raw(Model.SalesChartData), forecast: @Html.Raw(Model.ForecastChartData) },
        monthly: { labels: @Html.Raw(Model.MonthlySalesLabels), data: @Html.Raw(Model.MonthlySalesData),
            forecast: [] },
        quarterly: { labels: @Html.Raw(Model.QuarterlySalesLabels), data: @Html.Raw(Model.QuarterlySalesData), forecast: [] }
    };
    const catDataStore = {
        all: { labels: @Html.Raw(Model.CategoryLabels), data: @Html.Raw(Model.CategoryData) },
        month: { labels: @Html.Raw(Model.CategoryMonthlyLabels), data: @Html.Raw(Model.CategoryMonthlyData) },
        quarter: { labels: @Html.Raw(Model.CategoryQuarterlyLabels), data: @Html.Raw(Model.CategoryQuarterlyData) }
    };
    let salesChart, categoryChart;

    document.addEventListener('DOMContentLoaded', function () {
        initSalesChart();
        initCategoryChart();
        const savedCurrency = localStorage.getItem('sariCurrency') || 'PHP';
        if(window.applyCurrency) window.applyCurrency(savedCurrency);
    });
    function initSalesChart() {
        const ctx = document.getElementById('salesChart').getContext('2d');
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: salesDataStore.daily.labels,
                datasets: [
                    { label: 'Actual Sales', data: salesDataStore.daily.data, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', borderWidth: 3, tension:
                        0.4, fill: true },
                    { label: 'AI Forecast', data: salesDataStore.daily.forecast, borderColor: '#a855f7', borderDash: [5, 5], borderWidth: 2, tension: 0.4, pointStyle: 'star' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true,
                grid: { color: '#f3f4f6' } }, x: { grid: { display: false } } } }
        });
    }

    function updateSalesChart(mode) {
        document.querySelectorAll('[id^="btn-sales-"]').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-sales-${mode}`).classList.add('active');
        salesChart.data.labels = salesDataStore[mode].labels;
        salesChart.data.datasets[0].data = salesDataStore[mode].data;
        if(mode === 'daily') {
            salesChart.data.datasets[1].hidden = false;
            salesChart.data.datasets[1].data = salesDataStore[mode].forecast;
        } else {
            salesChart.data.datasets[1].hidden = true;
        }
        salesChart.update();
    }

    function initCategoryChart() {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: catDataStore.all.labels,
                datasets: [{ data: catDataStore.all.data, backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ef4444'], borderWidth: 0, hoverOffset: 10 }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 15 } } } }
        });
    }

    function updateCategoryChart(mode) {
        document.querySelectorAll('[id^="btn-cat-"]').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-cat-${mode}`).classList.add('active');
        categoryChart.data.labels = catDataStore[mode].labels;
        categoryChart.data.datasets[0].data = catDataStore[mode].data;
        categoryChart.update();
    }

    function downloadPdf() {
        const element = document.getElementById('report-content');

        // 1. Enter PDF Mode (Apply Styles)
        element.classList.add('show-in-pdf');
        element.classList.add('pdf-mode');

        // CRITICAL FIX: Calculate full content height
        // This tells the printer exactly how long the page is, preventing the "cut off" effect.
        const totalHeight = element.scrollHeight + 50;

        const opt = {
            margin: [0.3, 0.3, 0.3, 0.3], // Top, Left, Bottom, Right (Inches)
            filename: `Sari_Report_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
                scale: 2,
                useCORS: true,
                scrollY: 0,
                windowWidth: 800,       // Matches CSS width
                windowHeight: totalHeight // CRITICAL: Forces capture of full height
            },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
            // CHANGE THIS: Remove 'avoid-all' to let it flow naturally to page 2, 3, etc.
            pagebreak: { mode: ['css', 'legacy'] }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            // 2. Exit PDF Mode
            element.classList.remove('show-in-pdf');
            element.classList.remove('pdf-mode');
        });
    }
</script>