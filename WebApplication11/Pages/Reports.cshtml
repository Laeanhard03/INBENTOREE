@page
@model WebApplication11.Pages.ReportsModel
@{
    ViewData["Title"] = "Business Analytics";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* --- BENTO GRID SYSTEM --- */
    .bento-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 1.5rem;
    }

    .bento-col-span-12 {
        grid-column: span 12 / span 12;
    }

    .bento-col-span-8 {
        grid-column: span 12 / span 12;
    }
    /* Mobile: Full */
    .bento-col-span-4 {
        grid-column: span 12 / span 12;
    }
    /* Mobile: Full */

    @@media (min-width: 1024px) {
        .bento-col-span-8 {
            grid-column: span 8 / span 12;
        }

        .bento-col-span-4 {
            grid-column: span 4 / span 12;
        }
    }

    /* --- ASYMMETRICAL CARDS --- */
    .glass-card {
        background: white;
        border: 1px solid #f3f4f6;
        border-radius: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

    /* --- AI HUB STYLES --- */
    .ai-hub-gradient {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
    }

    .locked-state {
        background: rgba(255, 255, 255, 0.1);
        border: 1px dashed rgba(255, 255, 255, 0.3);
        border-radius: 1rem;
        padding: 1.5rem;
        text-align: center;
    }

    /* --- PDF HELPERS --- */
    .pdf-bg-white {
        background-color: #ffffff !important;
    }

    #pdf-appendix {
        display: none;
    }

    .show-in-pdf #pdf-appendix {
        display: block;
        margin-top: 2rem;
        border-top: 2px dashed #ccc;
        padding-top: 2rem;
    }

    .chart-toggle.active {
        background-color: #e0e7ff;
        color: #4338ca;
    }
</style>

<div class="space-y-6 pb-20">

    @* --- HEADER --- *@
    <div class="flex justify-between items-end mb-4">
        <div>
            <h1 class="text-3xl font-black text-gray-900 tracking-tight">Command Center</h1>
            <p class="text-sm text-gray-500">
                @if (Model.LastAnalysisDate.HasValue)
                {
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Systems Online • Last update: @Model.LastAnalysisDate.Value.ToLocalTime().ToString("h:mm tt")</span>
                }
                else
                {
                    <span class="flex items-center gap-1 text-orange-500"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Calibration Needed</span>
                }
            </p>
        </div>

        @* FAB for Export (Clean Look) *@
        <form method="post" asp-page-handler="DownloadReport">
            <button type="submit" class="bg-white border border-gray-200 text-gray-600 hover:text-indigo-600 hover:border-indigo-600 px-4 py-2 rounded-full text-xs font-bold transition shadow-sm flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Export Data
            </button>
        </form>
    </div>

    @* --- BENTO GRID LAYOUT --- *@
    <div id="report-content" class="bento-grid">

        @* --- 1. FINANCIAL PULSE (Hero Card) --- *@
        <div class="glass-card bento-col-span-8 p-6 flex flex-col justify-between relative">
            <div class="flex justify-between items-start mb-6">
                <div class="flex gap-8">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Total Revenue</p>
                        <h2 class="text-3xl font-black text-gray-900 price-display" data-price-php="@Model.TotalRevenue">₱@Model.TotalRevenue.ToString("N2")</h2>
                    </div>
                    <div class="hidden sm:block w-px bg-gray-100 h-12"></div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Net Profit</p>
                        <h2 class="text-3xl font-black text-emerald-600 price-display" data-price-php="@Model.TotalProfit">₱@Model.TotalProfit.ToString("N2")</h2>
                    </div>
                </div>

                @* Chart Toggles *@
                <div class="bg-gray-50 p-1 rounded-lg flex text-xs font-bold" data-html2canvas-ignore="true">
                    <button onclick="updateSalesChart('daily')" id="btn-sales-daily" class="chart-toggle px-3 py-1 rounded-md active">7D</button>
                    <button onclick="updateSalesChart('monthly')" id="btn-sales-monthly" class="chart-toggle px-3 py-1 rounded-md text-gray-500 hover:text-indigo-600">Month</button>
                    <button onclick="updateSalesChart('quarterly')" id="btn-sales-quarterly" class="chart-toggle px-3 py-1 rounded-md text-gray-500 hover:text-indigo-600">Qtr</button>
                </div>
            </div>

            @* Main Chart Area *@
            <div class="h-64 w-full relative">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        @* --- 2. SARI AI HUB (The Gatekeeper) --- *@
        <div class="glass-card bento-col-span-4 ai-hub-gradient p-6 flex flex-col relative overflow-hidden">
            <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-2xl"></div>

            <div class="flex items-center gap-3 mb-6 relative z-10">
                <div class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-xl shadow-inner">🧠</div>
                <div>
                    <h3 class="font-bold text-lg leading-none">Sari Intelligence</h3>
                    <p class="text-xs text-indigo-100 opacity-80 mt-1">Market Advisor</p>
                </div>
            </div>

            <div class="flex-grow relative z-10">
                @if (!Model.HasInventory)
                {
                    <div class="locked-state flex flex-col items-center justify-center h-full">
                        <svg class="w-8 h-8 text-indigo-200 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        <p class="text-sm font-bold text-white mb-1">Module Locked</p>
                        <p class="text-xs text-indigo-100 opacity-80 text-center">Add at least 1 product to unlock AI simulations.</p>
                        <a href="/Dash" class="mt-4 px-4 py-2 bg-white text-indigo-600 text-xs font-bold rounded-full hover:bg-indigo-50 transition">Go to Inventory</a>
                    </div>
                }
                else
                {
                    <div class="space-y-4">
                        <div class="bg-white/10 rounded-xl p-4 border border-white/10 backdrop-blur-sm">
                            <p class="text-xs font-bold text-indigo-200 uppercase mb-1">Forecast Insight</p>
                            <p class="text-sm font-medium leading-relaxed">@Model.HolidayPrediction</p>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <form method="post" asp-page-handler="Analyze" class="w-full">
                                <button type="submit" class="w-full py-3 bg-white/20 hover:bg-white/30 border border-white/20 rounded-xl text-xs font-bold transition flex flex-col items-center justify-center gap-1">
                                    <span class="text-lg">↻</span>
                                    <span>Re-Analyze</span>
                                </button>
                            </form>

                            <form method="post" asp-page-handler="RunSimulation" class="w-full" onsubmit="return confirm('Run AI Market Simulation? This will generate predictive sales data based on your current inventory.');">
                                <button type="submit" class="w-full py-3 bg-white text-indigo-600 hover:bg-indigo-50 border border-transparent rounded-xl text-xs font-bold transition flex flex-col items-center justify-center gap-1 shadow-lg">
                                    <span class="text-lg">⚡</span>
                                    <span>Run Sim</span>
                                </button>
                            </form>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* --- 3. ALERTS & METRICS --- *@

        @* Low Stock *@
        <div class="glass-card bento-col-span-4 p-5 flex items-center justify-between border-l-4 border-l-orange-500">
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase">Restock Alert</p>
                <h3 class="text-2xl font-black text-gray-900">@Model.LowStockItems.Count <span class="text-sm font-medium text-gray-400">items</span></h3>
            </div>
            <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
        </div>

        @* Total Orders *@
        <div class="glass-card bento-col-span-4 p-5 flex items-center justify-between border-l-4 border-l-blue-500">
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase">Total Orders</p>
                <h3 class="text-2xl font-black text-gray-900">@Model.TotalOrders</h3>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
            </div>
        </div>

        @* Forecast Value *@
        <div class="glass-card bento-col-span-4 p-5 flex items-center justify-between border-l-4 border-l-purple-500">
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase">AI 7-Day Revenue</p>
                <h3 class="text-2xl font-black text-purple-600 price-display" data-price-php="@Model.ForecastedRevenue">₱@Model.ForecastedRevenue.ToString("N0")</h3>
            </div>
            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            </div>
        </div>

        @* --- 4. TOP PERFORMERS (Compact) --- *@
        <div class="glass-card bento-col-span-4 p-6">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">🏆 Top Products</h3>
            <div class="space-y-4">
                @if (Model.TopSellingItems.Any())
                {
                    foreach (var item in Model.TopSellingItems.Take(4))
                    {
                        var max = Model.TopSellingItems.Max(x => x.QuantitySold);
                        var width = max > 0 ? (item.QuantitySold / (double)max) * 100 : 0;

                        <div class="relative">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-bold text-gray-700 truncate max-w-[70%]">@item.Name</span>
                                <span class="font-mono text-gray-500 price-display" data-price-php="@item.TotalRevenue">₱@item.TotalRevenue</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-indigo-500 h-1.5 rounded-full" style="width: @width%"></div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-xs text-gray-400 text-center py-4">No sales data recorded.</p>
                }
            </div>
        </div>

        @* --- 5. CATEGORY BREAKDOWN --- *@
        <div class="glass-card bento-col-span-4 p-6">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">📊 Category Split</h3>
            <div class="h-48 relative">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        @* --- 6. SLOW MOVERS (Compact) --- *@
        <div class="glass-card bento-col-span-4 p-6">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">🐢 Slow Movers <span class="text-[10px] bg-red-100 text-red-600 px-2 rounded-full ml-auto">Overstock</span></h3>
            <ul class="space-y-3">
                @if (Model.SlowMovingItems.Any())
                {
                    foreach (var item in Model.SlowMovingItems.Take(4))
                    {
                        <li class="flex justify-between items-center text-xs">
                            <span class="text-gray-600 truncate max-w-[70%]">@item.Name</span>
                            <span class="font-bold bg-gray-100 px-2 py-1 rounded text-gray-700">@item.Quantity left</span>
                        </li>
                    }
                }
                else
                {
                    <li class="text-xs text-gray-400 text-center py-4">Inventory is healthy.</li>
                }
            </ul>
        </div>
    </div>

    @* --- PDF APPENDIX (Hidden on screen) --- *@
    <div id="pdf-appendix">
        @* Simplified Appendix for printing *@
        <h2 class="text-2xl font-bold mb-4">Detailed Report</h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <h3 class="font-bold border-b pb-2 mb-2">Monthly Sales</h3>
                <table class="w-full text-xs">
                    @foreach (var m in Model.MonthlyStats)
                    {
                        <tr><td class="py-1">@m.Label</td><td class="text-right">₱@m.Total.ToString("N2")</td></tr>
                    }
                </table>
            </div>
            <div>
                <h3 class="font-bold border-b pb-2 mb-2">Quarterly Sales</h3>
                <table class="w-full text-xs">
                    @foreach (var q in Model.QuarterlyStats)
                    {
                        <tr><td class="py-1">@q.Label</td><td class="text-right">₱@q.Total.ToString("N2")</td></tr>
                    }
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    const salesDataStore = {
        daily: { labels: @Html.Raw(Model.SalesChartLabels), data: @Html.Raw(Model.SalesChartData), forecast: @Html.Raw(Model.ForecastChartData) },
        monthly: { labels: @Html.Raw(Model.MonthlySalesLabels), data: @Html.Raw(Model.MonthlySalesData), forecast: @Html.Raw(Model.MonthlyForecastData) },
        quarterly: { labels: @Html.Raw(Model.QuarterlySalesLabels), data: @Html.Raw(Model.QuarterlySalesData), forecast: @Html.Raw(Model.QuarterlyForecastData) }
    };
    const catDataStore = {
        all: { labels: @Html.Raw(Model.CategoryLabels), data: @Html.Raw(Model.CategoryData) }
    };
    let salesChart, categoryChart;

    document.addEventListener('DOMContentLoaded', function () {
        initSalesChart();
        initCategoryChart();
        const savedCurrency = localStorage.getItem('sariCurrency') || 'PHP';
        if(window.applyCurrency) window.applyCurrency(savedCurrency);
    });

    function initSalesChart() {
        const ctx = document.getElementById('salesChart').getContext('2d');
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: salesDataStore.daily.labels,
                datasets: [
                    { label: 'Actual', data: salesDataStore.daily.data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 3, tension: 0.4, fill: true },
                    { label: 'Forecast', data: salesDataStore.daily.forecast, borderColor: '#8b5cf6', borderDash: [5, 5], borderWidth: 2, tension: 0.4, pointStyle: 'rectRot' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } } }
        });
    }

    function updateSalesChart(mode) {
        document.querySelectorAll('[id^="btn-sales-"]').forEach(b => {
            b.classList.remove('active', 'bg-white', 'text-indigo-600', 'shadow-sm');
            b.classList.add('text-gray-500');
        });
        const btn = document.getElementById(`btn-sales-${mode}`);
        btn.classList.add('active', 'bg-white', 'text-indigo-600', 'shadow-sm');
        btn.classList.remove('text-gray-500');

        salesChart.data.labels = salesDataStore[mode].labels;
        salesChart.data.datasets[0].data = salesDataStore[mode].data;
        salesChart.data.datasets[1].data = salesDataStore[mode].forecast;
        salesChart.update();
    }

    function initCategoryChart() {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: catDataStore.all.labels,
                datasets: [{ data: catDataStore.all.data, backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6'], borderWidth: 0, hoverOffset: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
        });
    }
</script>